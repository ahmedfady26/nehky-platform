# 📊 نظام التتبع المتقدم لسلوك المستخدم - منصة نحكي

## 🎯 نظرة عامة

تم تطوير نظام تتبع متقدم يرصد جميع أنواع تفاعل المستخدم مع المحتوى ويحللها لتحسين تجربة التصفح وتخصيص الاقتراحات.

## 🚀 الميزات الرئيسية

### 📱 تتبع التمرير
- **عمق التمرير**: نسبة تمرير المستخدم خلال المحتوى (0-100%)
- **الوقت المقضي**: مدة بقاء المستخدم على كل منشور
- **سرعة التمرير**: px/second لفهم أسلوب التصفح
- **نقاط التوقف**: رصد التوقف أثناء القراءة
- **حالة الرؤية**: تتبع ما إذا كان المحتوى مرئياً للمستخدم

### 🎬 تتبع الفيديو
- **نسبة المشاهدة**: النسبة المئوية المشاهدة من إجمالي الفيديو
- **معدل الإكمال**: هل أكمل المستخدم مشاهدة الفيديو
- **عدد مرات التشغيل**: تكرار تشغيل نفس الفيديو
- **التحكم بالتشغيل**: عدد مرات الإيقاف والتقديم
- **نقطة الخروج**: الثانية التي توقف فيها المستخدم عن المشاهدة

### 👍 تتبع التفاعل
- **الإعجاب**: رصد النقرات على زر الإعجاب
- **التعليق**: تتبع فتح قسم التعليقات وكتابة تعليقات
- **المشاركة**: رصد مشاركة المحتوى
- **وقت التفاعل**: الوقت من رؤية المحتوى حتى التفاعل
- **موقع النقر**: إحداثيات النقر على الشاشة
- **نوع الجهاز**: تحديد ما إذا كان الجهاز محمول أم سطح مكتب

## 🧠 الذكاء الاصطناعي والتحليل

### تحديث الاهتمامات التلقائي
- **تحليل السلوك**: استنتاج الاهتمامات من سلوك التمرير والمشاهدة
- **نقاط الاهتمام**: نظام نقاط ذكي يحدد قوة الاهتمام
- **التحديث الفوري**: تحديث ملف المستخدم فور التفاعل

### أنواع المستخدمين
- **video_enthusiast**: محب للفيديوهات (يشاهد معظم الفيديوهات كاملة)
- **content_explorer**: مستكشف المحتوى (يقرأ ببطء ويتفاعل كثيراً)
- **quick_browser**: متصفح سريع (تمرير سريع)
- **engaged_user**: مستخدم متفاعل (تفاعل عالي مع المحتوى)
- **casual_user**: مستخدم عادي

## 🛠 التنفيذ التقني

### قاعدة البيانات
```sql
-- جداول التتبع الجديدة
UserScrollTracking     -- تتبع التمرير
UserVideoTracking      -- تتبع الفيديو  
UserInteractionTracking -- تتبع التفاعل
SmartUserProfile       -- الملف الذكي للمستخدم
```

### APIs الجديدة
- `POST /api/tracking/scroll` - تتبع سلوك التمرير
- `POST /api/tracking/video` - تتبع مشاهدة الفيديو
- `POST /api/tracking/interaction` - تتبع التفاعل

### مكونات React
- `AdvancedTracking` - مكون تغليف للتتبع التلقائي
- `TrackedPost` - مثال على منشور مع التتبع
- `useAdvancedTracking` - Hook للاستخدام المرن

## 📊 بيانات التتبع

### بيانات التمرير
```typescript
interface ScrollTrackingData {
  postId: string;
  userId: string;
  scrollDepth: number;      // 0-100%
  timeOnPost: number;       // ثواني
  scrollSpeed: number;      // px/second
  pauseTime: number;        // ثواني التوقف
  isVisible: boolean;
  sessionId: string;
}
```

### بيانات الفيديو
```typescript
interface VideoWatchingData {
  postId: string;
  userId: string;
  videoDuration: number;    // مدة الفيديو
  watchedDuration: number;  // المدة المشاهدة
  watchedPercentage: number; // 0-100%
  playCount: number;
  pauseCount: number;
  isCompleted: boolean;
}
```

### بيانات التفاعل
```typescript
interface InteractionTrackingData {
  postId: string;
  userId: string;
  interactionType: 'LIKE' | 'COMMENT' | 'SHARE' | 'PASSIVE_VIEW' | 'ACTIVE_VIEW';
  timeToInteract: number;   // ثواني
  clickPosition: { x: number; y: number };
  deviceType: string;
}
```

## 🔄 كيفية عمل النظام

### 1. التتبع التلقائي
```tsx
<AdvancedTracking postId="123" isVideo={true}>
  <Post content="..." />
</AdvancedTracking>
```

### 2. تتبع الأحداث
```typescript
// تتبع التمرير
useEffect(() => {
  // Intersection Observer للرؤية
  // Scroll listener للحركة
  // تجميع البيانات وإرسالها
}, []);

// تتبع الفيديو
video.addEventListener('play', () => {
  // تسجيل بداية التشغيل
});

// تتبع التفاعل
onClick={() => {
  trackInteraction('LIKE', { x: event.clientX, y: event.clientY });
}}
```

### 3. تحليل البيانات
```typescript
// تحديث الاهتمامات
if (interestScore > 0) {
  await prisma.userInterestScore.upsert({
    where: { userId_interestName: { userId, interestName } },
    update: { currentScore: { increment: interestScore } },
    create: { /* بيانات الاهتمام الجديد */ }
  });
}
```

## 🎮 كيفية الاختبار

### صفحة الاختبار
```
http://localhost:3000/tracking-test
```

### خطوات الاختبار
1. **اختبار التمرير**:
   - مرر ببطء عبر المنشورات
   - توقف عند محتوى مثير للاهتمام
   - لاحظ تتبع السلوك في Developer Tools

2. **اختبار الفيديو**:
   - شغل/أوقف الفيديو
   - جرب التقديم والتأخير
   - راقب تتبع نسبة المشاهدة

3. **اختبار التفاعل**:
   - اضغط أزرار الإعجاب والتعليق
   - شارك المحتوى
   - لاحظ تتبع موقع النقر

## 📈 فوائد النظام

### للمستخدمين
- **محتوى مخصص**: اقتراحات أكثر دقة
- **تجربة محسنة**: محتوى يناسب اهتماماتهم
- **توفير الوقت**: عرض المحتوى الأكثر صلة أولاً

### للمنصة
- **بيانات دقيقة**: فهم عميق لسلوك المستخدمين
- **تحسين الخوارزميات**: خوارزميات اقتراح أكثر ذكاءً
- **زيادة التفاعل**: محتوى أكثر جاذبية

### للمحتوى
- **تحليل الأداء**: معرفة ما يعجب المستخدمين
- **تحسين الجودة**: تطوير المحتوى بناءً على البيانات
- **استهداف أفضل**: وصول المحتوى للجمهور المناسب

## 🔮 التطوير المستقبلي

### المرحلة القادمة
- [ ] تحليل التوقيت (متى يكون المستخدم أكثر نشاطاً)
- [ ] تتبع المشاعر من التعليقات
- [ ] تحليل أنماط المشاركة الاجتماعية
- [ ] تتبع الصوت في الفيديوهات
- [ ] تحليل جودة المحتوى تلقائياً

### تحسينات إضافية
- [ ] تتبع حركة العين (Eye Tracking) للأجهزة المدعومة
- [ ] تحليل نبرة الصوت في التعليقات الصوتية
- [ ] تتبع الإيماءات في الأجهزة المحمولة
- [ ] ذكاء اصطناعي للتنبؤ بالاهتمامات المستقبلية

## 📝 ملاحظات مهمة

### الخصوصية
- جميع البيانات مجمعة ومجهولة الهوية للتحليل
- المستخدم يمكنه إيقاف التتبع في أي وقت
- البيانات تُستخدم فقط لتحسين التجربة

### الأداء
- التتبع يعمل في الخلفية دون التأثير على الأداء
- البيانات تُرسل بشكل غير متزامن
- تجميع البيانات قبل الإرسال لتقليل الطلبات

### الأمان
- تشفير جميع البيانات المرسلة
- التحقق من صحة البيانات قبل الحفظ
- حماية من الهجمات والبيانات المزيفة

## 🎉 الخلاصة

تم تطوير نظام تتبع متقدم وشامل يرصد جميع أنواع تفاعل المستخدم ويحللها بذكاء لتوفير تجربة مخصصة ومحسنة. النظام جاهز للاختبار والتطوير المستمر.
